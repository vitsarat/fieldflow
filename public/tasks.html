const pageSize = 10;
let currentPage = 1;
let lastDoc = null;
let firstDoc = null;
let totalTasks = 0;

// ดึงจำนวนงานทั้งหมด
async function getTotalTasks() {
    const snapshot = await db.collection('tasks').get();
    totalTasks = snapshot.size;
    document.getElementById('totalTasks').textContent = `ทั้งหมด: ${totalTasks} งาน`;
    document.getElementById('pageInfo').textContent = `หน้า ${currentPage} / ${Math.ceil(totalTasks / pageSize)}`;
}

// ดึงข้อมูลงานตามหน้า
async function loadTasks() {
    const taskList = document.getElementById('taskList');
    taskList.innerHTML = ''; // ล้างรายการก่อนหน้า

    let query = db.collection('tasks')
        .orderBy('createdAt', 'desc')
        .limit(pageSize);

    if (lastDoc && currentPage > 1) {
        query = query.startAfter(lastDoc);
    }

    const snapshot = await query.get();
    if (snapshot.empty) {
        taskList.innerHTML = '<tr><td colspan="5">ไม่มีข้อมูล</td></tr>';
        return;
    }

    firstDoc = snapshot.docs[0];
    lastDoc = snapshot.docs[snapshot.docs.length - 1];

    snapshot.forEach(doc => {
        const task = doc.data();
        const row = `
            <tr>
                <td>${task.taskId}</td>
                <td>${task.debtor}</td>
                <td>${task.address}</td>
                <td>${task.principle}</td>
                <td>${task.status}</td>
            </tr>
        `;
        taskList.innerHTML += row;
    });

    document.getElementById('pageInfo').textContent = `หน้า ${currentPage} / ${Math.ceil(totalTasks / pageSize)}`;
    document.getElementById('prevBtn').disabled = currentPage === 1;
    document.getElementById('nextBtn').disabled = currentPage === Math.ceil(totalTasks / pageSize);
}

// ฟังก์ชันสำหรับปุ่ม "ก่อนหน้า"
document.getElementById('prevBtn').addEventListener('click', async () => {
    if (currentPage > 1) {
        currentPage--;
        const query = db.collection('tasks')
            .orderBy('createdAt', 'desc')
            .endBefore(firstDoc)
            .limitToLast(pageSize);
        const snapshot = await query.get();
        firstDoc = snapshot.docs[0];
        lastDoc = snapshot.docs[snapshot.docs.length - 1];
        loadTasks();
    }
});

// ฟังก์ชันสำหรับปุ่ม "ถัดไป"
document.getElementById('nextBtn').addEventListener('click', () => {
    if (currentPage < Math.ceil(totalTasks / pageSize)) {
        currentPage++;
        loadTasks();
    }
});

// โหลดข้อมูลเมื่อหน้าโหลด
getTotalTasks();
loadTasks();
