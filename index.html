<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FieldFlow Dashboard</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: #1e2a44;
        color: #fff;
      }
      #loginScreen {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background: #f0f0f0;
      }
      #mainApp {
        display: none;
        height: 100vh;
        flex-direction: column;
      }
      .header {
        background: linear-gradient(to right, #2a5298, #1e3c72);
        padding: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .header h2 {
        margin: 0;
        font-size: 18px;
      }
      .header .icon {
        font-size: 18px;
        cursor: pointer;
      }
      .content {
        flex-grow: 1;
        padding: 15px;
        overflow-y: auto;
      }
      .bottom-menu {
        background: #2c3e50;
        padding: 10px;
        display: flex;
        justify-content: space-around;
        align-items: center;
      }
      .bottom-menu button {
        background: none;
        border: none;
        color: white;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .bottom-menu button i {
        margin-bottom: 5px;
        font-size: 20px;
      }
      .bottom-menu button:hover {
        color: #f1c40f;
      }
      .card {
        background: #fff;
        color: #333;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }
      .task-card {
        background: #fff;
        color: #333;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }
      .task-details {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
      }
      .details-box {
        background: white;
        color: #333;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 400px;
        max-height: 80vh;
        overflow-y: auto;
      }
      .status {
        padding: 5px 10px;
        border-radius: 5px;
      }
      .status-pending {
        background: #3498db;
        color: white;
      }
      .status-scheduled {
        background: #f1c40f;
        color: black;
      }
      .status-completed {
        background: #2ecc71;
        color: white;
      }
      .status-contact-fail {
        background: #e74c3c;
        color: white;
      }
      .urgent {
        color: #e74c3c;
        font-weight: bold;
      }
      .alert {
        background: #f39c12;
        color: white;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
      }
      .alert-critical {
        background: #e74c3c;
        color: white;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
      }
      .menu-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }
      .menu-item {
        background: #34495e;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        cursor: pointer;
      }
      .menu-item i {
        font-size: 24px;
        margin-bottom: 10px;
      }
      .menu-item:hover {
        background: #3e5c76;
      }
      #map {
        height: 60vh;
        width: 100%;
        margin-bottom: 15px;
      }
      .circle-progress {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0 auto;
        position: relative;
      }
      .circle-progress::before {
        content: attr(data-percent) "%";
        background: #fff;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }
      .table th,
      .table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }
      .table th {
        background: #34495e;
        color: white;
      }
      .table td {
        background: #fff;
        color: #333;
      }
      @media (max-width: 600px) {
        .header h2 {
          font-size: 16px;
        }
        .bottom-menu button {
          font-size: 12px;
        }
        .bottom-menu button i {
          font-size: 18px;
        }
        .card,
        .task-card {
          padding: 10px;
        }
        .menu-grid {
          gap: 10px;
        }
        .menu-item {
          padding: 15px;
        }
      }
    </style>
  </head>
  <body>
    <div id="loginScreen">
      <div>
        <h2>ล็อกอิน</h2>
        <input type="text" id="employeeId" placeholder="รหัสพนักงาน (เช่น A001)" /><br />
        <input type="password" id="password" placeholder="รหัสผ่าน" /><br />
        <button onclick="login()">เข้าสู่ระบบ</button>
      </div>
    </div>
    <div id="mainApp">
      <div class="header">
        <h2 id="pageTitle">แดชบอร์ด</h2>
        <i class="fas fa-sign-out-alt icon" onclick="logout()"></i>
      </div>
      <div class="content">
        <div id="dashboard" class="tab-content">
          <div id="alerts"></div>
          <div class="card">
            <p>
              <i class="fas fa-exclamation-triangle"></i> งานด่วน:
              <span id="urgentTasks"></span> งาน
            </p>
            <p>
              <i class="fas fa-check-circle"></i> งานสำเร็จ:
              <span id="completedTasks"></span> งาน
            </p>
            <p>
              <i class="fas fa-car"></i> รถยนต์: <span id="vehicles"></span> คัน
            </p>
          </div>
          <div class="menu-grid">
            <div class="menu-item" onclick="showTab('tasks')">
              <i class="fas fa-tasks"></i>
              <p>งาน (Tasks)</p>
            </div>
            <div class="menu-item" onclick="showTab('income')">
              <i class="fas fa-money-bill"></i>
              <p>รายได้ (Income)</p>
            </div>
            <div class="menu-item" onclick="showTab('report')">
              <i class="fas fa-chart-bar"></i>
              <p>รายงาน (Report)</p>
            </div>
            <div class="menu-item" onclick="showTab('map')">
              <i class="fas fa-map"></i>
              <p>แผนที่ (Map)</p>
            </div>
            <div class="menu-item" onclick="showTab('profile')">
              <i class="fas fa-user"></i>
              <p>โปรไฟล์ (Profile)</p>
            </div>
            <div class="menu-item" onclick="showTab('rating')">
              <i class="fas fa-star"></i>
              <p>คะแนน (Rating)</p>
            </div>
          </div>
        </div>
        <div id="tasks" class="tab-content" style="display: none">
          <div id="todo"></div>
          <div id="adminImport" style="display: none; margin-top: 20px;">
            <h3>นำเข้าข้อมูลงาน (สำหรับ ADMIN)</h3>
            <input type="file" id="importFile" accept=".csv" />
            <button onclick="importTasks()">นำเข้า</button>
          </div>
        </div>
        <div id="income" class="tab-content" style="display: none">
          <div class="card">
            <p>ยอดรวม: <span id="totalIncome"></span> บาท</p>
            <button onclick="showIncomeHistory()">ประวัติรายได้</button>
            <button onclick="downloadIncomeCSV()">ดาวน์โหลด</button>
          </div>
          <div class="card" id="incomeHistory" style="display: none">
            <h3>ประวัติรายได้</h3>
            <table class="table">
              <thead>
                <tr>
                  <th>เลขที่สัญญา</th>
                  <th>Commission</th>
                  <th>สถานะ</th>
                  <th>วันที่</th>
                  <th>หมายเหตุ</th>
                </tr>
              </thead>
              <tbody id="incomeTable"></tbody>
            </table>
          </div>
        </div>
        <div id="report" class="tab-content" style="display: none">
          <div id="reportAlerts"></div>
          <div class="card">
            <p>งาน 60/90 (Target <span id="target6090"></span>%)</p>
            <div
              class="circle-progress"
              id="progress6090"
              data-percent="0"
            ></div>
          </div>
          <div class="card">
            <p>งาน NPL (Target <span id="targetNPL"></span>%)</p>
            <div
              class="circle-progress"
              id="progressNPL"
              data-percent="0"
            ></div>
          </div>
          <div class="card">
            <h3>เปอร์เซ็นต์ % สำเร็จ</h3>
            <table class="table">
              <thead>
                <tr>
                  <th>ลำดับ</th>
                  <th>User</th>
                  <th>%</th>
                </tr>
              </thead>
              <tbody id="perfTable"></tbody>
            </table>
          </div>
          <div class="card">
            <h3>สรุปงาน</h3>
            <table class="table">
              <thead>
                <tr>
                  <th>รหัส</th>
                  <th>60/90 (สำเร็จ/ทั้งหมด)</th>
                  <th>NPL (สำเร็จ/ทั้งหมด)</th>
                </tr>
              </thead>
              <tbody id="summaryTable"></tbody>
            </table>
          </div>
        </div>
        <div id="map" class="tab-content" style="display: none">
          <div id="map"></div>
        </div>
        <div id="profile" class="tab-content" style="display: none">
          <div class="card">
            <p>ชื่อทีม: <span id="profileName"></span></p>
            <p>รหัสพนักงาน: <span id="profileId"></span></p>
            <p>เขตที่รับผิดชอบ: <span id="profileZone"></span></p>
            <p>สังกัด: <span id="profileAffiliation"></span></p>
            <p>บทบาท: <span id="profileRole"></span></p>
          </div>
        </div>
        <div id="rating" class="tab-content" style="display: none">
          <div class="card" id="ratingInfo"></div>
        </div>
      </div>
      <div class="bottom-menu">
        <button onclick="showTab('dashboard')">
          <i class="fas fa-tachometer-alt"></i> แดชบอร์ด
        </button>
        <button onclick="showTab('tasks')">
          <i class="fas fa-tasks"></i> งาน
        </button>
        <button onclick="showTab('income')">
          <i class="fas fa-money-bill"></i> รายได้
        </button>
        <button onclick="showTab('profile')">
          <i class="fas fa-user"></i> โปรไฟล์
        </button>
      </div>
    </div>
    <div class="task-details" id="taskDetails">
      <div class="details-box">
        <h3><i class="fas fa-info-circle"></i> รายละเอียดงาน</h3>
        <p>
          <i class="fas fa-file-contract"></i> เลขที่สัญญา:
          <input type="text" id="contractId" readonly />
        </p>
        <p>
          <i class="fas fa-user"></i> ชื่อ:
          <input type="text" id="customerName" />
        </p>
        <p>
          <i class="fas fa-home"></i> ที่อยู่:
          <input type="text" id="address" />
        </p>
        <p>
          <i class="fas fa-calendar-alt"></i> วันที่นัดหมาย:
          <input type="date" id="scheduledDate" />
        </p>
        <p>
          <i class="fas fa-map-pin"></i> Latitude:
          <input type="number" id="lat" step="0.0001" />
        </p>
        <p>
          <i class="fas fa-map-pin"></i> Longitude:
          <input type="number" id="lng" step="0.0001" />
        </p>
        <p>
          <i class="fas fa-info-circle"></i> สถานะ:
          <span id="taskStatus" class="status"></span>
        </p>
        <button onclick="saveTaskDetails()">บันทึก</button>
        <button onclick="closeTaskDetails()">ปิด</button>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      // Firebase Configuration
      const firebaseConfig = {
        apiKey: "AIzaSyDyOLP6v2mw5CRPMwVwynTU-qAAq8QMrlc",
        authDomain: "fieldflow-b3ee5.firebaseapp.com",
        projectId: "fieldflow-b3ee5",
        storageBucket: "fieldflow-b3ee5.firebasestorage.app",
        messagingSenderId: "384778621124",
        appId: "1:384778621124:web:1a40999850200d49c63991"
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();

      let userData = { id: "", isAdmin: false, teamName: "", teamZone: "" };
      let currentTask = null;
      let map;
      let data = { tasks: { list: [] }, income: { list: [] }, performance: {}, performanceList: [] };

      // ฟังก์ชันคำนวณระยะห่าง (Haversine Formula)
      let userLocation = { lat: 17.4060, lng: 102.7930 }; // สมมติตำแหน่งผู้ใช้

      function calculateDistance(lat1, lng1, lat2, lng2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLng / 2) * Math.sin(dLng / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return (R * c).toFixed(1);
      }

      function initMap() {
        map = L.map("map").setView([17.4075, 102.7893], 10);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution:
            '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        }).addTo(map);
      }

      // โหลดข้อมูลจาก Firestore
      async function fetchData() {
        try {
          const tasksSnapshot = await db.collection("tasks").get();
          data.tasks.list = tasksSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

          const incomeSnapshot = await db.collection("income").get();
          data.income.list = incomeSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

          const performanceSnapshot = await db.collection("performance").doc(userData.id).get();
          data.performance = performanceSnapshot.exists ? performanceSnapshot.data() : {};

          const performanceListSnapshot = await db.collection("performance").get();
          data.performanceList = performanceListSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

          updateUI(data);
        } catch (error) {
          console.error("Error fetching data:", error);
          alert("เกิดข้อผิดพลาดในการดึงข้อมูล: " + error.message);
          document.getElementById("mainApp").style.display = "none";
          document.getElementById("loginScreen").style.display = "flex";
        }
      }

      function updateUI(data) {
        window.sheetData = data;

        const today = new Date().toISOString().split("T")[0];
        const isAdmin = userData.isAdmin;

        const userTasks = isAdmin
          ? data.tasks.list
          : data.tasks.list.filter(
              (t) => t.assignedTo.toUpperCase() === userData.id.toUpperCase()
            );

        // Dashboard
        const urgentTasks = userTasks.filter((t) => t.urgent).length;
        const completedTasks = userTasks.filter((t) => t.status === "จบงานสำเร็จ").length;
        const vehicles = userTasks.filter((t) => t.licensePlate).length;

        document.getElementById("urgentTasks").textContent = urgentTasks;
        document.getElementById("completedTasks").textContent = completedTasks;
        document.getElementById("vehicles").textContent = vehicles;
        document.getElementById("alerts").innerHTML =
          urgentTasks > 0
            ? `<div class="alert">Alert: มีงานด่วน ${urgentTasks} งาน</div>`
            : "";

        // Tasks
        const todoColumn = document.getElementById("todo");
        todoColumn.innerHTML = "";
        userTasks.forEach((task) => {
          let distance = task.distance || "ไม่ระบุ";
          if (userLocation.lat && userLocation.lng && task.lat && task.lng) {
            distance = calculateDistance(
              userLocation.lat,
              userLocation.lng,
              task.lat,
              task.lng
            );
          }
          const card = document.createElement("div");
          card.className = "task-card";
          card.innerHTML = `
            <p><i class="fas fa-file-contract"></i> ${task.id} ${
              task.urgent
                ? '<span class="urgent"><i class="fas fa-exclamation-triangle"></i> ด่วน</span>'
                : ""
            }</p>
            <p><i class="fas fa-user"></i> ${task.name || "ไม่ระบุ"}</p>
            <p><i class="fas fa-home"></i> ${task.address || "ไม่ระบุ"}</p>
            <p><i class="fas fa-map-marker-alt"></i> ระยะ: ${distance} กม.</p>
            <p><i class="fas fa-clock"></i> เวลา: ${task.postedTime || "ไม่ระบุ"}</p>
            <p><i class="fas fa-money-bill"></i> เงินต้น: ${
              task.principle ? task.principle.toLocaleString() : "ไม่ระบุ"
            } บาท</p>
            <p><i class="fas fa-money-bill-wave"></i> ผ่อน: ${
              task.installment ? task.installment.toLocaleString() : "ไม่ระบุ"
            } บาท</p>
            <p><i class="fas fa-car"></i> ทะเบียน: ${task.licensePlate || "ไม่ระบุ"}</p>
            <div class="quick-actions">
              <button style="background: #2ecc71; color: white;" onclick="updateStatus('${
                task.id
              }', 'จบงานสำเร็จ')">จบงาน</button>
              <button style="background: #f1c40f; color: black;" onclick="updateStatus('${
                task.id
              }', 'นัดหมาย')">นัดหมาย</button>
              <button style="background: #3498db; color: white;" onclick='showTaskDetails(${JSON.stringify(
                task
              )})'>รายละเอียด</button>
            </div>
          `;
          todoColumn.appendChild(card);
        });

        if (isAdmin) {
          document.getElementById("adminImport").style.display = "block";
        } else {
          document.getElementById("adminImport").style.display = "none";
        }

        // Income
        const userIncome = isAdmin
          ? data.income.list
          : data.income.list.filter(
              (i) => i.employeeId.toUpperCase() === userData.id.toUpperCase()
            );
        const totalIncome = userIncome.reduce((sum, i) => sum + i.amount, 0);
        document.getElementById("totalIncome").textContent = totalIncome.toLocaleString();
        const incomeTable = document.getElementById("incomeTable");
        incomeTable.innerHTML = "";
        userIncome.forEach((income) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${income.contractId || "ไม่ระบุ"}</td>
            <td>${income.amount ? income.amount.toLocaleString() : "0"} บาท</td>
            <td>${income.status || "ไม่ระบุ"}</td>
            <td>${income.date || "ไม่ระบุ"}</td>
            <td>${income.note || "ไม่ระบุ"}</td>
          `;
          incomeTable.appendChild(row);
        });

        // Report
        const target6090 = 88;
        const targetNPL = 40;
        let total6090 = 0, completed6090 = 0, totalNPL = 0, completedNPL = 0;
        userTasks.forEach((task) => {
          if (task.group === "6090") {
            total6090++;
            if (task.status === "จบงานสำเร็จ") completed6090++;
          } else if (task.group === "NPL") {
            totalNPL++;
            if (task.status === "จบงานสำเร็จ") completedNPL++;
          }
        });
        const percent6090 = total6090 > 0 ? Math.round((completed6090 / total6090) * 100) : 0;
        const percentNPL = totalNPL > 0 ? Math.round((completedNPL / totalNPL) * 100) : 0;

        document.getElementById("target6090").textContent = target6090;
        document.getElementById("targetNPL").textContent = targetNPL;
        document.getElementById("progress6090").setAttribute("data-percent", percent6090);
        document.getElementById("progressNPL").setAttribute("data-percent", percentNPL);
        document.getElementById("progress6090").style.background = `conic-gradient(#2ecc71 0% ${percent6090}%, #e74c3c ${percent6090}% 100%)`;
        document.getElementById("progressNPL").style.background = `conic-gradient(#2ecc71 0% ${percentNPL}%, #e74c3c ${percentNPL}% 100%)`;

        const reportAlerts = document.getElementById("reportAlerts");
        reportAlerts.innerHTML = "";
        if (percent6090 < target6090) {
          reportAlerts.innerHTML += `<div class="alert-critical">รหัส ${userData.id}: งาน 60/90 ${percent6090}% ไม่ถึง Target ${target6090}%</div>`;
        }
        if (percentNPL < targetNPL) {
          reportAlerts.innerHTML += `<div class="alert-critical">รหัส ${userData.id}: งาน NPL ${percentNPL}% ไม่ถึง Target ${targetNPL}%</div>`;
        }

        const perfTable = document.getElementById("perfTable");
        perfTable.innerHTML = "";
        data.performanceList.forEach((perf, index) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${index + 1}</td>
            <td>${perf.id}</td>
            <td>${perf.successRate || 0}%</td>
          `;
          perfTable.appendChild(row);
        });

        const summaryTable = document.getElementById("summaryTable");
        summaryTable.innerHTML = "";
        userTasks.forEach((task) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${task.id}</td>
            <td>${task.group === "6090" ? `${task.status === "จบงานสำเร็จ" ? 1 : 0}/1` : "0/0"}</td>
            <td>${task.group === "NPL" ? `${task.status === "จบงานสำเร็จ" ? 1 : 0}/1` : "0/0"}</td>
          `;
          summaryTable.appendChild(row);
        });

        // Map
        if (map && document.getElementById("map").style.display !== "none") {
          map.eachLayer((layer) => {
            if (layer instanceof L.Marker) map.removeLayer(layer);
          });
          // ตำแหน่งผู้ใช้
          L.marker([17.4060, 102.7930], { icon: L.icon({ iconUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png", iconSize: [25, 41] }) })
            .addTo(map)
            .bindPopup("ตำแหน่งของคุณ");
          // ตำแหน่งงาน
          userTasks.forEach((task) => {
            if (task.lat && task.lng) {
              let markerIcon = "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-green.png";
              if (task.assignedTo === "A002") {
                markerIcon = "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-red.png";
              }
              const marker = L.marker([task.lat, task.lng], { icon: L.icon({ iconUrl: markerIcon, iconSize: [25, 41] }) })
                .addTo(map)
                .bindPopup(`
                  <b>${task.id}</b><br>
                  ${task.name || "ไม่ระบุ"}<br>
                  ${task.address || "ไม่ระบุ"}<br>
                  สถานะ: ${task.status || "ไม่ระบุ"}<br>
                  <button onclick='showTaskDetails(${JSON.stringify(task)})'>รายละเอียด</button><br>
                  <button onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${task.lat},${task.lng}', '_blank')">นำทาง</button>
                `);
              marker.on("click", () => map.setView([task.lat, task.lng], 15));
            }
          });
          if (userTasks.length > 0 && userTasks[0].lat && userTasks[0].lng) {
            map.setView([userTasks[0].lat, userTasks[0].lng], 10);
          }
        }

        // Profile
        document.getElementById("profileName").textContent = userData.teamName;
        document.getElementById("profileId").textContent = userData.id;
        document.getElementById("profileZone").textContent = userData.teamZone;
        document.getElementById("profileAffiliation").textContent = data.performance?.affiliation || "ไม่ระบุ";
        document.getElementById("profileRole").textContent = isAdmin ? "ผู้ดูแลระบบ" : "พนักงาน";

        // Rating
        const ratingInfo = document.getElementById("ratingInfo");
        if (isAdmin) {
          ratingInfo.innerHTML = `
            <p>คะแนนของ A001: ${data.performanceList?.find(p => p.id === "A001")?.score || 0}</p>
            <p>คะแนนของ A002: ${data.performanceList?.find(p => p.id === "A002")?.score || 0}</p>
          `;
        } else {
          ratingInfo.innerHTML = `<p>คะแนน: ${data.performance?.score || 0}</p>`;
        }
      }

      async function login() {
        const id = document.getElementById("employeeId").value.trim().toUpperCase();
        const pass = document.getElementById("password").value;

        // ตรวจสอบว่ากรอกข้อมูลครบหรือไม่
        if (!id || !pass) {
          alert("กรุณากรอกรหัสพนักงานและรหัสผ่าน");
          return;
        }

        // ตรวจสอบรูปแบบรหัสพนักงาน (ต้องเป็นตัวอักษรและตัวเลขเท่านั้น)
        const idRegex = /^[A-Za-z0-9]+$/;
        if (!idRegex.test(id)) {
          alert("รหัสพนักงานต้องประกอบด้วยตัวอักษรและตัวเลขเท่านั้น (เช่น A001)");
          return;
        }

        const email = `${id.toLowerCase()}@fieldflow.com`;

        try {
          const userCredential = await auth.signInWithEmailAndPassword(email, pass);
          const user = userCredential.user;

          // ดึงข้อมูลผู้ใช้จาก Firestore
          const userDoc = await db.collection("users").doc(user.uid).get();
          if (!userDoc.exists) {
            throw new Error("ไม่พบข้อมูลผู้ใช้ในระบบ (Firestore)");
          }
          const userDataFromFirestore = userDoc.data();

          userData.id = id;
          userData.isAdmin = userDataFromFirestore.isAdmin || false;
          userData.teamZone = id.startsWith("A")
            ? "อุดรธานี"
            : id.startsWith("B")
            ? "ขอนแก่น"
            : "ไม่ระบุ";
          userData.teamName = id.startsWith("A")
            ? "ทีมรุ่งเรือง"
            : id.startsWith("B")
            ? "ทีมเอสดี"
            : "ไม่ระบุ";
          if (userData.isAdmin) userData.teamName = "แอดมิน";

          document.getElementById("loginScreen").style.display = "none";
          const mainApp = document.getElementById("mainApp");
          mainApp.style.display = "flex";
          mainApp.style.flexDirection = "column";
          document.getElementById("pageTitle").textContent = userData.isAdmin
            ? "แอดมิน"
            : "แดชบอร์ด";
          alert(`ยินดีต้อนรับ ${userData.teamName}!`);
          fetchData();
        } catch (error) {
          console.error("Login error:", error);
          let errorMessage = "เกิดข้อผิดพลาดในการล็อกอิน";
          if (error.code === "auth/user-not-found") {
            errorMessage = "ไม่พบผู้ใช้ในระบบ กรุณาตรวจสอบรหัสพนักงาน";
          } else if (error.code === "auth/wrong-password") {
            errorMessage = "รหัสผ่านไม่ถูกต้อง";
          } else if (error.code === "auth/invalid-email") {
            errorMessage = "รูปแบบอีเมลไม่ถูกต้อง";
          } else if (error.code === "auth/invalid-credential") {
            errorMessage = "ข้อมูลการล็อกอินไม่ถูกต้อง";
          } else {
            errorMessage = error.message;
          }
          alert(errorMessage);
        }
      }

      function logout() {
        auth.signOut().then(() => {
          userData = { id: "", isAdmin: false, teamName: "", teamZone: "" };
          document.getElementById("mainApp").style.display = "none";
          document.getElementById("loginScreen").style.display = "flex";
          alert("ออกจากระบบสำเร็จ!");
        }).catch((error) => {
          console.error("Logout error:", error);
          alert("เกิดข้อผิดพลาดในการออกจากระบบ: " + error.message);
        });
      }

      function showTab(tabId) {
        document
          .querySelectorAll(".tab-content")
          .forEach((tab) => (tab.style.display = "none"));
        document.getElementById(tabId).style.display = "block";
        document.getElementById("pageTitle").textContent =
          tabId === "dashboard"
            ? userData.isAdmin
              ? "แอดมิน"
              : "แดชบอร์ด"
            : tabId === "tasks"
            ? "งาน (Tasks)"
            : tabId === "income"
            ? "รายได้ (Income)"
            : tabId === "report"
            ? "รายงาน (Report)"
            : tabId === "map"
            ? "แผนที่ (Map)"
            : tabId === "profile"
            ? "โปรไฟล์ (Profile)"
            : "คะแนน (Rating)";
        if (tabId === "map" && !map) initMap();
        fetchData();
      }

      function showTaskDetails(task) {
        currentTask = task;
        document.getElementById("taskDetails").style.display = "flex";
        document.getElementById("contractId").value = task.contractId || "";
        document.getElementById("customerName").value = task.name || "";
        document.getElementById("address").value = task.address || "";
        document.getElementById("scheduledDate").value = task.scheduledDate || "";
        document.getElementById("lat").value = task.lat || "";
        document.getElementById("lng").value = task.lng || "";
        document.getElementById("taskStatus").textContent = task.status || "";
        document.getElementById("taskStatus").className = `status status-${
          task.status === "ติดต่อไม่ได้"
            ? "contact-fail"
            : task.status === "นัดหมาย"
            ? "scheduled"
            : task.status === "จบงานสำเร็จ"
            ? "completed"
            : "pending"
        }`;
      }

      async function saveTaskDetails() {
        if (currentTask) {
          const updatedTask = {
            ...currentTask,
            contractId: document.getElementById("contractId").value,
            name: document.getElementById("customerName").value,
            address: document.getElementById("address").value,
            scheduledDate: document.getElementById("scheduledDate").value,
            lat: parseFloat(document.getElementById("lat").value) || 0,
            lng: parseFloat(document.getElementById("lng").value) || 0
          };

          try {
            await db.collection("tasks").doc(currentTask.id).set(updatedTask);
            alert("บันทึกข้อมูลสำเร็จ!");
            closeTaskDetails();
            fetchData();
          } catch (error) {
            console.error("Error saving task:", error);
            alert("เกิดข้อผิดพลาดในการบันทึก: " + error.message);
          }
        }
      }

      async function updateStatus(taskId, status) {
        try {
          await db.collection("tasks").doc(taskId).update({ status });
          alert("อัปเดตสถานะสำเร็จ!");
          fetchData();
        } catch (error) {
          console.error("Error updating status:", error);
          alert("เกิดข้อผิดพลาดในการอัปเดตสถานะ: " + error.message);
        }
      }

      function closeTaskDetails() {
        document.getElementById("taskDetails").style.display = "none";
      }

      function showIncomeHistory() {
        const incomeHistory = document.getElementById("incomeHistory");
        incomeHistory.style.display =
          incomeHistory.style.display === "none" ? "block" : "none";
      }

      function downloadIncomeCSV() {
        if (!window.sheetData || !window.sheetData.income) {
          alert("ไม่มีข้อมูลรายได้สำหรับดาวน์โหลด");
          return;
        }
        const userIncome = userData.isAdmin
          ? window.sheetData.income.list
          : window.sheetData.income.list.filter(
              (i) => i.employeeId.toUpperCase() === userData.id.toUpperCase()
            );
        const csvRows = [
          ["เลขที่สัญญา", "Commission", "สถานะ", "วันที่", "หมายเหตุ"],
          ...userIncome.map((income) => [
            income.contractId || "ไม่ระบุ",
            income.amount ? income.amount.toLocaleString() : "0",
            income.status || "ไม่ระบุ",
            income.date || "ไม่ระบุ",
            income.note || "ไม่ระบุ"
          ]),
        ];
        const csvContent = csvRows.map((row) => row.join(",")).join("\n");
        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "income_report.csv";
        link.click();
      }

      // ฟังก์ชันนำเข้าข้อมูลงาน (สำหรับ ADMIN)
      function importTasks() {
        if (!userData.isAdmin) {
          alert("เฉพาะแอดมินเท่านั้นที่สามารถนำเข้าข้อมูลได้");
          return;
        }

        const fileInput = document.getElementById("importFile");
        const file = fileInput.files[0];
        if (!file) {
          alert("กรุณาเลือกไฟล์ CSV");
          return;
        }

        const reader = new FileReader();
        reader.onload = async (e) => {
          const text = e.target.result;
          const rows = text.split("\n").map(row => row.split(","));
          const headers = rows[0];
          const tasks = rows.slice(1).map(row => {
            const task = {};
            headers.forEach((header, index) => {
              task[header.trim()] = row[index] ? row[index].trim() : "";
            });
            return task;
          });

          // ตรวจสอบ id ซ้ำ
          const existingTasks = data.tasks.list.map(task => task.id);
          const duplicateTasks = tasks.filter(task => existingTasks.includes(task.id));
          if (duplicateTasks.length > 0) {
            alert(`พบรหัสงานซ้ำ: ${duplicateTasks.map(t => t.id).join(", ")}`);
            return;
          }

          // นำเข้าข้อมูลไปยัง Firestore
          const batch = db.batch();
          tasks.forEach((task) => {
            if (task.id) {
              const taskRef = db.collection("tasks").doc(task.id);
              batch.set(taskRef, {
                id: task.id,
                name: task.name,
                address: task.address,
                lat: parseFloat(task.lat),
                lng: parseFloat(task.lng),
                contractId: task.contractId,
                principle: parseFloat(task.principle),
                installment: parseFloat(task.installment),
                licensePlate: task.licensePlate,
                postedTime: task.postedTime,
                scheduledDate: task.scheduledDate,
                group: task.group,
                urgent: task.urgent === "true",
                assignedTo: task.assignedTo,
                teamName: task.teamName,
                status: task.status || "รอดำเนินการ",
              });
            }
          });

          try {
            await batch.commit();
            alert(`นำเข้า ${tasks.length} งานสำเร็จ`);
            fetchData();
          } catch (error) {
            console.error("Error importing tasks:", error);
            alert("เกิดข้อผิดพลาดในการนำเข้า: " + error.message);
          }
        };
        reader.readAsText(file);
      }
    </script>
  </body>
</html>
