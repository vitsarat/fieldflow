<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FieldFlow Admin</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css"
    />
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js"></script>
    <script src="/firebase.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background: #f1e2a44;
        color: #fff;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
      }
      .btn {
        padding: 10px 20px;
        background: #1e2a40;
        color: #fff;
        border: none;
        cursor: pointer;
      }
      .btn:hover {
        background: #2a3b5a;
      }
      .form-group {
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Admin Dashboard</h1>
      <button
        class="btn"
        onclick="firebase.auth().signOut().then(() => window.location.href = 'index.html')"
      >
        ออกจากระบบ
      </button>
      <div class="form-group">
        <label for="workFile">อินพุตงาน (ไฟล์):</label>
        <input
          type="file"
          id="workFile"
          class="form-control"
          accept=".xlsx,.csv"
        />
        <button onclick="uploadWork()" class="btn mt-2">อัพโหลดงาน</button>
        <div id="upload-message" style="color: green; display: none"></div>
        <div id="upload-error" style="color: red; display: none"></div>
      </div>
      <h3>รายการงานที่อัพโหลด</h3>
      <table class="table">
        <thead>
          <tr>
            <th>ชื่อไฟล์</th>
            <th>วันที่อัพโหลด</th>
            <th>ลิงก์</th>
          </tr>
        </thead>
        <tbody id="workList"></tbody>
      </table>
    </div>

    <script>
      const storage = firebase.storage();
      const db = firebase.firestore();

      firebase.auth().onAuthStateChanged((user) => {
        if (!user) {
          window.location.href = "index.html";
        } else {
          loadWorks();
        }
      });

      async function uploadWork() {
        const fileInput = document.getElementById("workFile");
        const file = fileInput.files[0];
        const uploadMessage = document.getElementById("upload-message");
        const uploadError = document.getElementById("upload-error");

        if (!file) {
          uploadError.textContent = "กรุณาเลือกไฟล์ก่อนอัพโหลด";
          uploadError.style.display = "block";
          return;
        }

        if (!file.name.endsWith(".xlsx") && !file.name.endsWith(".csv")) {
          uploadError.textContent = "กรุณาอัพโหลดไฟล์ .xlsx หรือ .csv เท่านั้น";
          uploadError.style.display = "block";
          return;
        }

        try {
          const storageRef = storage.ref(`works/${file.name}`);
          const snapshot = await storageRef.put(file);
          const downloadURL = await snapshot.ref.getDownloadURL();

          await db.collection("works").add({
            name: file.name,
            url: downloadURL,
            uploadedBy: firebase.auth().currentUser.uid,
            uploadedAt: firebase.firestore.FieldValue.serverTimestamp(),
          });

          uploadMessage.textContent = "อัพโหลดงานสำเร็จ!";
          uploadMessage.style.display = "block";
          uploadError.style.display = "none";
          fileInput.value = "";
        } catch (error) {
          console.error("Upload error:", error);
          uploadError.textContent =
            "เกิดข้อผิดพลาดในการอัพโหลด: " + error.message;
          uploadError.style.display = "block";
          uploadMessage.style.display = "none";
        }
      }

      function loadWorks() {
        const workList = document.getElementById("workList");
        db.collection("works")
          .orderBy("uploadedAt", "desc")
          .onSnapshot((snapshot) => {
            workList.innerHTML = "";
            snapshot.forEach((doc) => {
              const work = doc.data();
              const row = `
                        <tr>
                            <td>${work.name}</td>
                            <td>${
                              work.uploadedAt
                                ? new Date(
                                    work.uploadedAt.toDate()
                                  ).toLocaleString()
                                : "N/A"
                            }</td>
                            <td><a href="${
                              work.url
                            }" target="_blank">ดาวน์โหลด</a></td>
                        </tr>
                    `;
              workList.innerHTML += row;
            });
          });
      }
    </script>
  </body>
</html>
